@page "/register"

@using RecipePlannerApi.Model;
@using RecipePlannerApi.Service;
@using RecipePlannerApi.Dao;
@using RecipePlannerWebApp.LocalServices;
@using System.Text.RegularExpressions;
@inject UserSessionData currentUserData;
@inject NavigationManager Nav;
@inject IJSRuntime JsRuntime;

<link href="RecipePlannerWebApp.styles.css" rel="stylesheet">
<PageTitle>foodie - register</PageTitle>

<EditForm Model="@user" OnValidSubmit="@RegisterUser">
    <div id="registration-widget">
        <span class="header">Register for Foodie</span>
        <button style="position:center" @onclick="goToLogin">&#8672 Back</button>
        <br />
        <input id="usernameField" @bind="user.Username" placeholder="Enter Username" required />

        <input id="passwordField" @bind="user.Password" placeholder="Enter Password" required />
        <input id="passwordReentryField" @bind="this.passwordReentry" placeholder="Re-enter Password" required />

        <input id="fnameField" @bind="user.FirstName" placeholder="Enter First Name" required />

        <input id="lnameField" @bind="user.LastName" placeholder="Enter Last Name" required />

        <input id="emailField" type="email" @bind="user.Email" @onfocusout="validateEmail" placeholder="Enter Email Address" required/>

        <button type="submit" id="submitButton" style="position:center">Submit</button>
    </div>
</EditForm>

@code {
    [Parameter]
    public User user { get; set; } = new User();
    public bool ValidFields { get; set; }

    private string passwordReentry { get; set; } = "";
    private UserService service { get; set; } = new UserService(new UserDao(), new PantryDao());

    /**
     * Handles page initialization of the Register component
     */
    private void RegisterUser()
    {
        this.ValidFields = false;
        if (String.Equals(this.user.Password, this.passwordReentry))
        {
            try
            {
                var regResult = this.service.CreateUser(this.user);
                Console.WriteLine("REGISTER -- REG_RESULT " + regResult);
                this.ValidFields = true;

                this.currentUserData.CurrentUser = new User() { Id = (int)regResult };
                Nav.NavigateTo("/planner");
            }
            catch (System.Data.SqlClient.SqlException sqlEx)
            {
                this.alertUser("The username you entered is already in use.\nPlease enter a different username.");
                this.clearUsername();
                Console.WriteLine("\nSQL ERR -- ");
                Console.WriteLine(sqlEx.Message);
            }
            catch (System.Exception exc)
            {
                this.alertUser("There was an issue processing your registration");
                Console.WriteLine("\nERR -- ");
                Console.WriteLine(exc.Message);
            }
            Console.WriteLine("REGISTER -- SUCCESS");
            Console.WriteLine("REGISTER -- " + this.user.Username);

        }
        else
        {
            this.alertUser("Password values do not match");
            this.clearPasswordFields();
        }
    }

    /**
     * Alerts the user in the event that an error occurred and
     * displays the given message.
     * @param message - the error message to be displayed to
     *      the user.
     */
    private async void alertUser(string message)
    {
        await JsRuntime.InvokeVoidAsync("alert", message);
    }

    /**
     * Clears the password data fields
     */
    private void clearPasswordFields()
    {
        this.user.Password = "";
        this.passwordReentry = "";
    }

    /**
     * Clears the username data field
     */
    private void clearUsername()
    {
        this.user.Username = "";
    }

    private async void validateEmail()
    {
        var pattern = new Regex("^\\w+@[a-zA-Z_]+?\\.[a-zA-Z]{2,3}$",
            RegexOptions.Compiled | RegexOptions.IgnoreCase);
        if (!pattern.IsMatch(this.user.Email) && !String.IsNullOrEmpty(this.user.Email))
        {
            await JsRuntime.InvokeAsync<object>("alert", "Please enter a valid email.");
            this.user.Email = "";
            StateHasChanged();
        }
    }

    /**
     * Handles page navigation back to the Login page
     */
    private void goToLogin()
    {
        Nav.NavigateTo("/");
    }
}
