@page "/"
@using RecipePlannerApi.Model;
@using RecipePlannerApi.Service;
@using RecipePlannerApi.Dao;
@using RecipePlannerWebApp.LocalServices;
@inject NavigationManager Nav;
@inject UserSessionData userData;
@layout LoginLayout;

<PageTitle>foodie - login</PageTitle>

<link href="RecipePlannerWebApp.styles.css" rel="stylesheet">

<EditForm Model="@user" OnValidSubmit="@ValidateUser">
    <div id="login-widget">
        <span class="header">Login to Foodie</span>
       
        <input id="usernameField" @bind="user.Username" placeholder="Enter username" required />
      
        <input id="passwordField" type="password" @bind="user.Password" placeholder="Enter password" required />
       
        <button type="submit" id="loginButton" style="position:center">Login</button>
        <button type="submit" id="registerButton" style="position:center" @onclick="RegisterUser">Register</button>
        
        <span id="loginResultMessage">@LoginValidationResultMessage</span>
    </div>
</EditForm>

@code
{
    [Parameter]
    public User? user { get; set; } = new User();

    [Parameter]
    public bool ValidFields { get; set; }

    private string? LoginValidationResultMessage { get; set; }
    private UserService service { get; set; } = new UserService(new UserDao(), new PantryDao());

    /**
     * Initializes the Login component
     */
    protected override void OnInitialized()
    {
        Console.WriteLine("LOGIN -- Initializing...");
        this.ValidFields = false;
        userData.CurrentUser = new User();
    }

    /**
     * Handles user validation by performing some basic input validation
     * before sending data to the user validation service.
     */
    private void ValidateUser()
    {

        LoginValidationResultMessage = "";
        if (!String.IsNullOrEmpty(this.user?.Username) && !String.IsNullOrEmpty(this.user?.Password))
        {
            int? result = this.service.ValidateUser(this.user.Username, this.user.Password);
            LoginValidationResultMessage = "";
            if (result != null)
            {
                Console.WriteLine(result);
                this.ValidFields = true;
                this.user.Id = result ?? -1;
                userData.CurrentUser = this.user;
                Nav.NavigateTo("/planner");
            }
            else
            {
                this.ValidFields = false;
                LoginValidationResultMessage = "Invalid Credentials";
            }
        }
        else
        {
            LoginValidationResultMessage = "Please enter a username and password";
        }
    }

    /**
     * Handles page navigation to the register page
     */
    private void RegisterUser()
    {
        Nav.NavigateTo("/register");
    }
}